<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แผงควบคุมแอดมิน - ระบบส่งเอกสารโรงเรียนลองวิทยา</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Prompt', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .admin-info {
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 10px 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 12px 24px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }

        .admin-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 14px;
        }

        .tab-button.active {
            background: #667eea;
            color: white;
        }

        .tab-button:hover {
            background: #5a6fd8;
            color: white;
        }

        .search-box {
            padding: 12px 20px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            width: 300px;
            transition: border-color 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .file-list {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #e1e1e1;
            border-radius: 12px;
            background: #fafafa;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            background: white;
        }

        .file-item:hover {
            background-color: #f8f9ff;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .file-meta {
            font-size: 0.9rem;
            color: #666;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .file-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .file-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .download-btn {
            background: #28a745;
            color: white;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .delete-btn {
            background: #dc3545;
            color: white;
        }

        .delete-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .view-btn {
            background: #007bff;
            color: white;
        }

        .view-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .export-btn {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tab-buttons {
                justify-content: center;
            }
            
            .search-box {
                width: 100%;
            }
            
            .file-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-header">
            <a href="index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> กลับหน้าส่งเอกสาร
            </a>
            
            <div class="admin-info">
                <span><i class="fas fa-user-shield"></i> แอดมิน</span>
                <span id="loginTime"></span>
                <a href="admin-login.html" class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> ออกจากระบบ
                </a>
            </div>
        </div>

        <div class="header">
            <h1><i class="fas fa-shield-alt"></i> แผงควบคุมแอดมิน</h1>
            <p>จัดการเอกสารระบบส่งเอกสารโรงเรียนลองวิทยา</p>
        </div>

        <!-- Dashboard สถิติ -->
        <div class="admin-section">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-chart-bar"></i> สถิติภาพรวม</h2>
            <div class="dashboard-stats">
                <div class="stat-card">
                    <i class="fas fa-file-alt"></i>
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">เอกสารทั้งหมด</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div class="stat-number" id="totalTeachers">0</div>
                    <div class="stat-label">ครูที่ส่งแล้ว</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-day"></i>
                    <div class="stat-number" id="todayFiles">0</div>
                    <div class="stat-label">ไฟล์วันนี้</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-hdd"></i>
                    <div class="stat-number" id="totalSize">0 MB</div>
                    <div class="stat-label">ขนาดรวม</div>
                </div>
            </div>
        </div>

        <!-- จัดการไฟล์ -->
        <div class="admin-section">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-folder-open"></i> จัดการเอกสาร</h2>
            
            <div class="controls">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="filterFiles('all')">
                        <i class="fas fa-list"></i> ทั้งหมด
                    </button>
                    <button class="tab-button" onclick="filterFiles('PA69')">PA69</button>
                    <button class="tab-button" onclick="filterFiles('PA70')">PA70</button>
                    <button class="tab-button" onclick="filterFiles('PA71')">PA71</button>
                    <button class="tab-button" onclick="filterFiles('PA72')">PA72</button>
                    <button class="tab-button" onclick="filterFiles('PA73')">PA73</button>
                    <button class="tab-button" onclick="filterFiles('HRMS')">HRMS</button>
                    <button class="tab-button" onclick="filterFiles('LICENSE')">ใบประกอบวิชาชีพ</button>
                </div>
                
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="searchBox" class="search-box" placeholder="ค้นหาชื่อครูหรือชื่อไฟล์..." onkeyup="searchFiles()">
                    <button class="export-btn" onclick="exportData()">
                        <i class="fas fa-download"></i> ส่งออกข้อมูล
                    </button>
                </div>
            </div>

            <div class="file-list" id="fileList">
                <div class="empty-state">
                    <i class="fas fa-folder-open"></i>
                    <h3>ยังไม่มีเอกสารที่ส่งมา</h3>
                    <p>เมื่อครูส่งเอกสารมาแล้ว จะแสดงรายการที่นี่</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ตรวจสอบการเข้าสู่ระบบ
        function checkLogin() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            const loginTime = sessionStorage.getItem('loginTime');
            
            if (!isLoggedIn || isLoggedIn !== 'true') {
                // ไม่ได้เข้าสู่ระบบ
                window.location.href = 'admin-login.html';
                return false;
            }
            
            // ตรวจสอบว่า session หมดอายุหรือไม่ (24 ชั่วโมง)
            if (loginTime) {
                const loginDate = new Date(loginTime);
                const currentDate = new Date();
                const hoursDiff = (currentDate - loginDate) / (1000 * 60 * 60);
                
                if (hoursDiff > 24) {
                    // Session หมดอายุ
                    logout();
                    return false;
                }
                
                // แสดงเวลาเข้าสู่ระบบ
                document.getElementById('loginTime').textContent = 
                    `เข้าสู่ระบบเมื่อ: ${loginDate.toLocaleString('th-TH')}`;
            }
            
            return true;
        }

        // ออกจากระบบ
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            sessionStorage.removeItem('loginTime');
            window.location.href = 'admin-login.html';
        }

        // ตรวจสอบการเข้าสู่ระบบเมื่อโหลดหน้า
        if (!checkLogin()) {
            // หยุดการทำงานถ้าไม่ได้เข้าสู่ระบบ
            document.body.innerHTML = '<div style="text-align: center; padding: 50px; font-size: 1.5rem;">กำลังเปลี่ยนเส้นทาง...</div>';
        }

        // Google Drive API Configuration
        const GOOGLE_DRIVE_CONFIG = {
            folderId: '1c_7i6kzQNYtrHh7rJ-UShaZjC8Tfnp9A',
            serviceAccountEmail: 'document-uploader@boxwood-faculty-472505-g7.iam.gserviceaccount.com'
        };

        // ⚠️ แทนที่ URL นี้ด้วย URL ของ Google Apps Script ที่คุณสร้าง
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyEG63B31NSRmtcTbiMjcc_5AY1FN05iyWZaDs3jn6axJH87kw--yQs6Hbd5GGrSz5O/exec';

        // ข้อมูลไฟล์ที่อัปโหลด
        let uploadedFiles = [];
        let currentFilter = 'all';
        let filteredFiles = uploadedFiles;

        // โหลดข้อมูลไฟล์จาก Google Apps Script
        async function loadFiles() {
            try {
                if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL === 'URL_ของคุณ') {
                    console.warn('Apps Script URL not configured, using localStorage');
                    uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
                    updateStatistics();
                    displayFiles();
                    return;
                }

                const response = await fetch(`${APPS_SCRIPT_URL}?action=getFiles`);
                const contentType = response.headers.get('content-type');
                
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Response is not JSON');
                }

                const result = await response.json();
                
                if (result.success) {
                    uploadedFiles = result.files;
                    updateStatistics();
                    filterFiles(currentFilter);
                } else {
                    console.error('Apps Script error:', result.error);
                    uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
                    updateStatistics();
                    displayFiles();
                }
                
            } catch (error) {
                console.error('Error loading files:', error);
                uploadedFiles = JSON.parse(localStorage.getItem('uploadedFiles')) || [];
                updateStatistics();
                displayFiles();
            }
        }

        // อัปเดตสถิติ
        function updateStatistics() {
            document.getElementById('totalFiles').textContent = uploadedFiles.length;
            
            const uniqueTeachers = [...new Set(uploadedFiles.map(file => file.teacherName))];
            document.getElementById('totalTeachers').textContent = uniqueTeachers.length;
            
            const today = new Date().toDateString();
            const todayFiles = uploadedFiles.filter(file => new Date(file.uploadDate).toDateString() === today);
            document.getElementById('todayFiles').textContent = todayFiles.length;
            
            const totalSizeBytes = uploadedFiles.reduce((sum, file) => sum + (file.fileSize || 0), 0);
            const totalSizeMB = (totalSizeBytes / 1024 / 1024).toFixed(1);
            document.getElementById('totalSize').textContent = totalSizeMB + ' MB';
        }

        // แสดงรายการไฟล์
        function displayFiles(files = filteredFiles) {
            const fileList = document.getElementById('fileList');
            
            if (files.length === 0) {
                fileList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>${currentFilter === 'all' ? 'ยังไม่มีเอกสารที่ส่งมา' : 'ไม่มีเอกสารในหมวดนี้'}</h3>
                        <p>เมื่อครูส่งเอกสารมาแล้ว จะแสดงรายการที่นี่</p>
                    </div>
                `;
                return;
            }
            
            fileList.innerHTML = files.map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">
                            <i class="fas fa-file-${getFileIcon(file.fileName)}"></i>
                            ${file.fileName || file.originalFileName}
                        </div>
                        <div class="file-meta">
                            <span><i class="fas fa-user"></i> ${file.teacherName}</span>
                            <span><i class="fas fa-tag"></i> ${getDocumentTypeName(file.documentType)}</span>
                            <span><i class="fas fa-calendar"></i> ${new Date(file.uploadDate).toLocaleDateString('th-TH')}</span>
                            <span><i class="fas fa-clock"></i> ${new Date(file.uploadDate).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}</span>
                            <span><i class="fas fa-hdd"></i> ${(file.fileSize / 1024 / 1024).toFixed(2)} MB</span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="action-btn view-btn" onclick="viewFile(${uploadedFiles.indexOf(file)})">
                            <i class="fas fa-eye"></i> ดู
                        </button>
                        <button class="action-btn download-btn" onclick="downloadFile(${uploadedFiles.indexOf(file)})">
                            <i class="fas fa-download"></i> ดาวน์โหลด
                        </button>
                        <button class="action-btn delete-btn" onclick="deleteFile(${uploadedFiles.indexOf(file)})">
                            <i class="fas fa-trash"></i> ลบ
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ได้ไอคอนไฟล์ตามนามสกุล
        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'pdf',
                'doc': 'word',
                'docx': 'word',
                'xls': 'excel',
                'xlsx': 'excel',
                'jpg': 'image',
                'jpeg': 'image',
                'png': 'image'
            };
            return iconMap[extension] || 'alt';
        }

        // แปลงชื่อประเภทเอกสาร
        function getDocumentTypeName(type) {
            const types = {
                'PA69': 'PA69',
                'PA70': 'PA70', 
                'PA71': 'PA71',
                'PA72': 'PA72',
                'PA73': 'PA73',
                'HRMS': 'HRMS',
                'LICENSE': 'ใบประกอบวิชาชีพ'
            };
            return types[type] || type;
        }

        // กรองไฟล์ตามประเภท
        function filterFiles(filter) {
            currentFilter = filter;
            
            // อัปเดตปุ่ม active
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // กรองไฟล์
            if (filter === 'all') {
                filteredFiles = uploadedFiles;
            } else {
                filteredFiles = uploadedFiles.filter(file => file.documentType === filter);
            }
            
            // ค้นหาเพิ่มเติมถ้ามีคำค้นหา
            const searchTerm = document.getElementById('searchBox').value;
            if (searchTerm) {
                searchFiles();
            } else {
                displayFiles(filteredFiles);
            }
        }

        // ค้นหาไฟล์
        function searchFiles() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            if (!searchTerm) {
                displayFiles(filteredFiles);
                return;
            }
            
            const searchResults = filteredFiles.filter(file => 
                file.teacherName.toLowerCase().includes(searchTerm) ||
                (file.fileName && file.fileName.toLowerCase().includes(searchTerm)) ||
                (file.originalFileName && file.originalFileName.toLowerCase().includes(searchTerm))
            );
            
            displayFiles(searchResults);
        }

        // ดูไฟล์
        function viewFile(index) {
            const file = uploadedFiles[index];
            if (file.webViewLink) {
                window.open(file.webViewLink, '_blank');
            } else {
                alert(`ดูไฟล์: ${file.fileName || file.originalFileName}\nครู: ${file.teacherName}\nประเภท: ${getDocumentTypeName(file.documentType)}`);
            }
        }

        // ดาวน์โหลดไฟล์
        function downloadFile(index) {
            const file = uploadedFiles[index];
            if (file.webViewLink) {
                window.open(file.webViewLink, '_blank');
            } else {
                alert(`ดาวน์โหลดไฟล์: ${file.fileName || file.originalFileName}\nจาก Google Drive โฟลเดอร์: เอกสารโรงเรียน-2569/${getDocumentTypeName(file.documentType)}`);
            }
        }

        // ลบไฟล์
        async function deleteFile(index) {
            const file = uploadedFiles[index];
            if (!confirm(`คุณแน่ใจหรือไม่ที่จะลบไฟล์นี้?\n\nไฟล์: ${file.fileName || file.originalFileName}\nครู: ${file.teacherName}`)) {
                return;
            }

            try {
                // ลบจาก Google Apps Script
                if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== 'URL_ของคุณ' && file.id) {
                    const response = await fetch(`${APPS_SCRIPT_URL}?action=deleteFile&fileId=${file.id}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('ลบไฟล์จาก Google Drive เรียบร้อยแล้ว');
                    } else {
                        alert('เกิดข้อผิดพลาดในการลบไฟล์จาก Google Drive: ' + result.error);
                    }
                }

                // ลบจาก localStorage และอัปเดตการแสดงผล
                uploadedFiles.splice(index, 1);
                localStorage.setItem('uploadedFiles', JSON.stringify(uploadedFiles));
                
                // อัปเดตการแสดงผล
                filterFiles(currentFilter);
                updateStatistics();
                
            } catch (error) {
                console.error('Error deleting file:', error);
                alert('เกิดข้อผิดพลาดในการลบไฟล์');
            }
        }

        // ส่งออกข้อมูล
        function exportData() {
            if (uploadedFiles.length === 0) {
                alert('ไม่มีข้อมูลให้ส่งออก');
                return;
            }
            
            // สร้างข้อมูล CSV
            const headers = ['ชื่อไฟล์', 'ชื่อครู', 'ประเภทเอกสาร', 'วันที่อัปโหลด', 'ขนาดไฟล์ (MB)'];
            const csvData = uploadedFiles.map(file => [
                file.fileName || file.originalFileName,
                file.teacherName,
                getDocumentTypeName(file.documentType),
                new Date(file.uploadDate).toLocaleDateString('th-TH'),
                (file.fileSize / 1024 / 1024).toFixed(2)
            ]);
            
            // รวมหัวข้อกับข้อมูล
            const allData = [headers, ...csvData];
            
            // แปลงเป็น CSV string
            const csvString = allData.map(row => 
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
            
            // สร้าง Blob และดาวน์โหลด
            const blob = new Blob(['\ufeff' + csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `รายงานเอกสาร_${new Date().toLocaleDateString('th-TH')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ตรวจสอบ session ทุก 5 นาที
        setInterval(() => {
            if (!checkLogin()) {
                return;
            }
        }, 5 * 60 * 1000); // 5 minutes

        // เริ่มต้นระบบ
        loadFiles();
        
        // อัปเดตข้อมูลทุก 30 วินาที
        setInterval(() => {
            if (checkLogin()) {
                loadFiles();
            }
        }, 30000);
